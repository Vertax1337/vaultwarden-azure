{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "5690648528040617136"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for all resources"
      }
    },
    "appName": {
      "type": "string",
      "defaultValue": "vaultwarden",
      "metadata": {
        "description": "Name of the Vaultwarden Container App"
      }
    },
    "domainUrl": {
      "type": "string",
      "metadata": {
        "description": "Public URL of your Vaultwarden instance. MUST include https:// (example: https://sub.domain.tld)"
      }
    },
    "vaultwardenImage": {
      "type": "string",
      "defaultValue": "vaultwarden/server:1.33.2",
      "metadata": {
        "description": "Container image to use for Vaultwarden (pin a version for reproducible deployments)"
      }
    },
    "cpuCores": {
      "type": "string",
      "defaultValue": "0.25",
      "metadata": {
        "description": "CPU cores for the container"
      }
    },
    "memorySize": {
      "type": "string",
      "defaultValue": "0.5",
      "metadata": {
        "description": "Memory in GiB for the container (CPU:RAM ratio must be 1:2)"
      }
    },
    "allowInsecureHttp": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Allow insecure HTTP traffic (recommended: false for production)"
      }
    },
    "smtpHost": {
      "type": "string",
      "defaultValue": "smtp.office365.com",
      "metadata": {
        "description": "SMTP host (M365 default: smtp.office365.com)"
      }
    },
    "smtpPort": {
      "type": "string",
      "defaultValue": "587",
      "metadata": {
        "description": "SMTP port (M365 default: 587)"
      }
    },
    "smtpSecurity": {
      "type": "string",
      "defaultValue": "starttls",
      "allowedValues": [
        "starttls",
        "force_tls",
        "off"
      ],
      "metadata": {
        "description": "SMTP security (starttls / force_tls / off)"
      }
    },
    "smtpFrom": {
      "type": "string",
      "metadata": {
        "description": "SMTP FROM address (e.g. vaultwarden@domain.tld)"
      }
    },
    "smtpUsername": {
      "type": "string",
      "metadata": {
        "description": "SMTP username (often same as smtpFrom)"
      }
    },
    "smtpPassword": {
      "type": "securestring",
      "metadata": {
        "description": "SMTP password"
      }
    },
    "dbAdminUser": {
      "type": "string",
      "defaultValue": "vaultwarden",
      "metadata": {
        "description": "PostgreSQL admin username"
      }
    },
    "dbPassword": {
      "type": "securestring",
      "metadata": {
        "description": "PostgreSQL admin password (will be stored in Key Vault for later retrieval)"
      }
    },
    "postgresSkuName": {
      "type": "string",
      "defaultValue": "Standard_B1ms",
      "metadata": {
        "description": "PostgreSQL SKU name"
      }
    },
    "postgresStorageGB": {
      "type": "int",
      "defaultValue": 32,
      "metadata": {
        "description": "PostgreSQL storage size in GB"
      }
    },
    "allowAzureServicesToPostgres": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Allow Azure services to access PostgreSQL (0.0.0.0 firewall rule). Recommended: false."
      }
    },
    "storageAccountSku": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "allowedValues": [
        "Standard_LRS",
        "Standard_ZRS",
        "Standard_GRS",
        "Standard_RAGRS",
        "Standard_GZRS",
        "Standard_RAGZRS"
      ],
      "metadata": {
        "description": "Storage account SKU for Azure Files"
      }
    }
  },
  "variables": {
    "storageAccountName": "[toLower(format('{0}files{1}', parameters('appName'), uniqueString(resourceGroup().id)))]",
    "fileShareName": "vaultwarden",
    "postgresServerName": "[toLower(format('{0}-pg-{1}', parameters('appName'), uniqueString(resourceGroup().id)))]",
    "postgresDbName": "vaultwarden",
    "postgresFqdn": "[format('{0}.postgres.database.azure.com', variables('postgresServerName'))]",
    "postgresPort": "5432",
    "logAnalyticsName": "[format('{0}-law', parameters('appName'))]",
    "containerEnvName": "[format('{0}-env', parameters('appName'))]",
    "keyVaultName": "[toLower(format('vwkv{0}', uniqueString(resourceGroup().id)))]",
    "kvSecretAdminTokenName": "vw-admin-token",
    "kvSecretDbPasswordName": "vw-db-password",
    "roleKeyVaultSecretsOfficer": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b86a8fe4-44ce-4948-aee5-eccb2c155cd7')]",
    "roleKeyVaultSecretsUser": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2023-09-01",
      "name": "[variables('logAnalyticsName')]",
      "location": "[parameters('location')]",
      "properties": {
        "retentionInDays": 30
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2023-05-01",
      "name": "[variables('storageAccountName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "[parameters('storageAccountSku')]"
      },
      "kind": "StorageV2",
      "properties": {
        "allowBlobPublicAccess": false,
        "minimumTlsVersion": "TLS1_2",
        "supportsHttpsTrafficOnly": true
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/fileServices",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', variables('storageAccountName'), 'default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), 'default', variables('fileShareName'))]",
      "properties": {
        "accessTier": "Hot"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/fileServices', variables('storageAccountName'), 'default')]"
      ]
    },
    {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2023-07-01",
      "name": "[variables('keyVaultName')]",
      "location": "[parameters('location')]",
      "properties": {
        "tenantId": "[subscription().tenantId]",
        "sku": {
          "family": "A",
          "name": "standard"
        },
        "enableRbacAuthorization": true,
        "enabledForDeployment": false,
        "enabledForTemplateDeployment": true,
        "enabledForDiskEncryption": false,
        "publicNetworkAccess": "Enabled",
        "softDeleteRetentionInDays": 90,
        "enablePurgeProtection": true
      }
    },
    {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2023-01-31",
      "name": "[format('{0}-id', parameters('appName'))]",
      "location": "[parameters('location')]"
    },
    {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2023-01-31",
      "name": "[format('{0}-kv-writer-id', parameters('appName'))]",
      "location": "[parameters('location')]"
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.KeyVault/vaults/{0}', variables('keyVaultName'))]",
      "name": "[guid(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-kv-writer-id', parameters('appName'))), variables('roleKeyVaultSecretsOfficer'))]",
      "properties": {
        "roleDefinitionId": "[variables('roleKeyVaultSecretsOfficer')]",
        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-kv-writer-id', parameters('appName'))), '2023-01-31').principalId]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-kv-writer-id', parameters('appName')))]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.KeyVault/vaults/{0}', variables('keyVaultName'))]",
      "name": "[guid(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-id', parameters('appName'))), variables('roleKeyVaultSecretsUser'))]",
      "properties": {
        "roleDefinitionId": "[variables('roleKeyVaultSecretsUser')]",
        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-id', parameters('appName'))), '2023-01-31').principalId]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-id', parameters('appName')))]",
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2023-08-01",
      "name": "[format('{0}-ensure-kv-secrets', parameters('appName'))]",
      "location": "[parameters('location')]",
      "kind": "AzureCLI",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-kv-writer-id', parameters('appName'))))]": {}
        }
      },
      "properties": {
        "azCliVersion": "2.60.0",
        "timeout": "PT30M",
        "retentionInterval": "P1D",
        "cleanupPreference": "OnSuccess",
        "environmentVariables": [
          {
            "name": "KEYVAULT_NAME",
            "value": "[variables('keyVaultName')]"
          },
          {
            "name": "ADMIN_TOKEN_SECRET",
            "value": "[variables('kvSecretAdminTokenName')]"
          },
          {
            "name": "DB_PASSWORD_SECRET",
            "value": "[variables('kvSecretDbPasswordName')]"
          },
          {
            "name": "DB_PASSWORD_VALUE",
            "secureValue": "[parameters('dbPassword')]"
          }
        ],
        "scriptContent": "set -euo pipefail\n\necho \"Ensuring Key Vault secrets exist in $KEYVAULT_NAME ...\"\n\n# ADMIN_TOKEN: generate if missing\nif az keyvault secret show --vault-name \"$KEYVAULT_NAME\" --name \"$ADMIN_TOKEN_SECRET\" 1>/dev/null 2>/dev/null; then\n  echo \"ADMIN_TOKEN secret already exists.\"\nelse\n  echo \"Creating ADMIN_TOKEN secret...\"\n  ADMIN_TOKEN=$(python3 - << 'PY'\nimport secrets, base64\nprint(base64.urlsafe_b64encode(secrets.token_bytes(48)).decode('utf-8').rstrip('='))\nPY\n)\n  az keyvault secret set --vault-name \"$KEYVAULT_NAME\" --name \"$ADMIN_TOKEN_SECRET\" --value \"$ADMIN_TOKEN\" 1>/dev/null\n  echo \"ADMIN_TOKEN secret created.\"\nfi\n\n# DB password: store if missing\nif az keyvault secret show --vault-name \"$KEYVAULT_NAME\" --name \"$DB_PASSWORD_SECRET\" 1>/dev/null 2>/dev/null; then\n  echo \"DB password secret already exists.\"\nelse\n  echo \"Creating DB password secret...\"\n  az keyvault secret set --vault-name \"$KEYVAULT_NAME\" --name \"$DB_PASSWORD_SECRET\" --value \"$DB_PASSWORD_VALUE\" 1>/dev/null\n  echo \"DB password secret created.\"\nfi\n\necho \"Done.\"\n"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
        "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-kv-writer-id', parameters('appName'))), variables('roleKeyVaultSecretsOfficer')))]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-kv-writer-id', parameters('appName')))]"
      ]
    },
    {
      "type": "Microsoft.DBforPostgreSQL/flexibleServers",
      "apiVersion": "2023-03-01-preview",
      "name": "[variables('postgresServerName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "[parameters('postgresSkuName')]",
        "tier": "Burstable"
      },
      "properties": {
        "administratorLogin": "[parameters('dbAdminUser')]",
        "administratorLoginPassword": "[parameters('dbPassword')]",
        "version": "15",
        "storage": {
          "storageSizeGB": "[parameters('postgresStorageGB')]"
        },
        "authConfig": {
          "passwordAuth": "Enabled",
          "activeDirectoryAuth": "Disabled"
        },
        "backup": {
          "backupRetentionDays": 7
        }
      }
    },
    {
      "condition": "[parameters('allowAzureServicesToPostgres')]",
      "type": "Microsoft.DBforPostgreSQL/flexibleServers/firewallRules",
      "apiVersion": "2023-03-01-preview",
      "name": "[format('{0}/{1}', variables('postgresServerName'), 'AllowAzure')]",
      "properties": {
        "startIpAddress": "0.0.0.0",
        "endIpAddress": "0.0.0.0"
      },
      "dependsOn": [
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]"
      ]
    },
    {
      "type": "Microsoft.DBforPostgreSQL/flexibleServers/databases",
      "apiVersion": "2023-03-01-preview",
      "name": "[format('{0}/{1}', variables('postgresServerName'), variables('postgresDbName'))]",
      "dependsOn": [
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]"
      ]
    },
    {
      "type": "Microsoft.App/managedEnvironments",
      "apiVersion": "2024-03-01",
      "name": "[variables('containerEnvName')]",
      "location": "[parameters('location')]",
      "properties": {
        "appLogsConfiguration": {
          "destination": "log-analytics",
          "logAnalyticsConfiguration": {
            "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName')), '2023-09-01').customerId]",
            "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName')), '2023-09-01').primarySharedKey]"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsName'))]"
      ]
    },
    {
      "type": "Microsoft.App/managedEnvironments/storages",
      "apiVersion": "2024-03-01",
      "name": "[format('{0}/{1}', variables('containerEnvName'), 'vaultwarden-storage')]",
      "properties": {
        "azureFile": {
          "accountName": "[variables('storageAccountName')]",
          "shareName": "[variables('fileShareName')]",
          "accountKey": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-05-01').keys[0].value]",
          "accessMode": "ReadWrite"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.App/managedEnvironments', variables('containerEnvName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
      ]
    },
    {
      "type": "Microsoft.App/containerApps",
      "apiVersion": "2024-03-01",
      "name": "[parameters('appName')]",
      "location": "[parameters('location')]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-id', parameters('appName'))))]": {}
        }
      },
      "properties": {
        "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', variables('containerEnvName'))]",
        "configuration": {
          "ingress": {
            "external": true,
            "targetPort": 80,
            "allowInsecure": "[parameters('allowInsecureHttp')]"
          },
          "secrets": [
            {
              "name": "admin-token",
              "keyVaultUrl": "[format('https://{0}.{1}/secrets/{2}', variables('keyVaultName'), environment().suffixes.keyvaultDns, variables('kvSecretAdminTokenName'))]",
              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-id', parameters('appName')))]"
            },
            {
              "name": "db-password",
              "keyVaultUrl": "[format('https://{0}.{1}/secrets/{2}', variables('keyVaultName'), environment().suffixes.keyvaultDns, variables('kvSecretDbPasswordName'))]",
              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-id', parameters('appName')))]"
            },
            {
              "name": "smtp-password",
              "value": "[parameters('smtpPassword')]"
            }
          ]
        },
        "template": {
          "containers": [
            {
              "name": "vaultwarden",
              "image": "[parameters('vaultwardenImage')]",
              "resources": {
                "cpu": "[json(parameters('cpuCores'))]",
                "memory": "[format('{0}Gi', parameters('memorySize'))]"
              },
              "env": [
                {
                  "name": "ADMIN_TOKEN",
                  "secretRef": "admin-token"
                },
                {
                  "name": "DATABASE_HOST",
                  "value": "[variables('postgresFqdn')]"
                },
                {
                  "name": "DATABASE_PORT",
                  "value": "[variables('postgresPort')]"
                },
                {
                  "name": "DATABASE_NAME",
                  "value": "[variables('postgresDbName')]"
                },
                {
                  "name": "DATABASE_USERNAME",
                  "value": "[parameters('dbAdminUser')]"
                },
                {
                  "name": "DATABASE_PASSWORD",
                  "secretRef": "db-password"
                },
                {
                  "name": "DATABASE_SSLMODE",
                  "value": "require"
                },
                {
                  "name": "DOMAIN",
                  "value": "[parameters('domainUrl')]"
                },
                {
                  "name": "SMTP_HOST",
                  "value": "[parameters('smtpHost')]"
                },
                {
                  "name": "SMTP_PORT",
                  "value": "[parameters('smtpPort')]"
                },
                {
                  "name": "SMTP_SECURITY",
                  "value": "[parameters('smtpSecurity')]"
                },
                {
                  "name": "SMTP_FROM",
                  "value": "[parameters('smtpFrom')]"
                },
                {
                  "name": "SMTP_USERNAME",
                  "value": "[parameters('smtpUsername')]"
                },
                {
                  "name": "SMTP_PASSWORD",
                  "secretRef": "smtp-password"
                }
              ],
              "volumeMounts": [
                {
                  "volumeName": "data",
                  "mountPath": "/data"
                }
              ]
            }
          ],
          "volumes": [
            {
              "name": "data",
              "storageType": "AzureFile",
              "storageName": "vaultwarden-storage"
            }
          ],
          "scale": {
            "minReplicas": 1,
            "maxReplicas": 1
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-id', parameters('appName')))]",
        "[resourceId('Microsoft.App/managedEnvironments', variables('containerEnvName'))]",
        "[resourceId('Microsoft.App/managedEnvironments/storages', variables('containerEnvName'), 'vaultwarden-storage')]",
        "[resourceId('Microsoft.Resources/deploymentScripts', format('{0}-ensure-kv-secrets', parameters('appName')))]",
        "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-id', parameters('appName'))), variables('roleKeyVaultSecretsUser')))]",
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers/databases', variables('postgresServerName'), variables('postgresDbName'))]"
      ]
    }
  ],
  "outputs": {
    "containerAppFqdn": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('appName')), '2024-03-01').configuration.ingress.fqdn]"
    },
    "keyVaultName": {
      "type": "string",
      "value": "[variables('keyVaultName')]"
    }
  }
}
